<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <meta name="version" content="S5 1.1" />
  <meta name="author" content="Luiza Andrade and Sushmita Samaddar" />
  <title>Constructing datasets - Part 1</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <!-- configuration parameters -->
  <meta name="defaultView" content="slideshow" />
  <meta name="controlVis" content="hidden" />
  <!-- style sheet links -->
  <link rel="stylesheet" href="c:/ado/plus/m/s5/santiago/slides.css" type="text/css" media="projection" id="slideProj" />
  <link rel="stylesheet" href="c:/ado/plus/m/s5/santiago/outline.css" type="text/css" media="screen" id="outlineStyle" />
  <link rel="stylesheet" href="c:/ado/plus/m/s5/santiago/print.css" type="text/css" media="print" id="slidePrint" />
  <link rel="stylesheet" href="c:/ado/plus/m/s5/santiago/opera.css" type="text/css" media="projection" id="operaFix" />
  <!-- S5 JS -->
  <script src="c:/ado/plus/m/s5/santiago/slides.js" type="text/javascript"></script>
</head>
<body>
<div class="layout">
<div id="controls"></div>
<div id="currentSlide"></div>
<div id="header"></div>
<div id="footer">
  <h1></h1>
  <h2>Constructing datasets - Part 1</h2>
</div>
</div>
<div class="presentation">
<div class="title-slide slide">
  <h1 class="title">Constructing datasets - Part 1</h1>
  <h3 class="author">Luiza Andrade and Sushmita Samaddar</h3>
</div>
<div id="what-is-data-construction" class="slide section level1">
<h1>What is data construction</h1>
<ul>
<li>Constructing variables means processing the data points as provided in the raw data to make them suitable for analysis</li>
<li>Construction transform clean data into analysis data</li>
<li>This is done by creating derived variables (e.g. dummies, indices, interactions), reshaping, combining and aggregating data sets</li>
<li>It is the only stage when changes will be made to data points</li>
<li>Construction is closely linked to research design and questionnaire design</li>
<li>Ideally, indicator construction should be done right after data cleaning, according to the pre-analysis plan</li>
</ul>
<pre class="{s/}"><code>use &quot;../DataWork/Data/Clean/process_clean.dta&quot;, clear</code></pre>
</div>
<div id="what-is-data-construction-1" class="slide section level1">
<h1>What is data construction</h1>
<ul>
<li>Inputs
<ul>
<li>One or more clean data sets</li>
</ul></li>
<li>Outputs
<ul>
<li>One or more constructed data sets</li>
<li>One data dictionary/codebook for each constructed data set</li>
<li>Construction documentation</li>
</ul></li>
<li>Tasks
<ul>
<li>Unit of observation <span class="math inline">→</span> Unit of analysis</li>
<li>Observed measurement <span class="math inline">→</span> Analysis indicator</li>
</ul></li>
</ul>
</div>
<div id="why-is-construction-a-separate-task-from-data-cleaning" class="slide section level1">
<h1>Why is construction a separate task from data cleaning?</h1>
<ol style="list-style-type: decimal">
<li>To clearly differentiate the data originally acquired data from the result of data processing decisions</li>
<li>To ensure that variable definition is consistent across data sources</li>
</ol>
<ul>
<li>For example, we may have multiple rounds of data collection that will be cleaned separately, but we want all of them to be constructed in the same manner</li>
</ul>
</div>
<div id="what-to-plan-ahead" class="slide section level1">
<h1>What to plan ahead</h1>
<ul>
<li>What are the final indicators needed to answer a research question</li>
<li>How they are defined and calculated</li>
<li>What are the steps to get there</li>
<li>How to deal with different rounds of data collections</li>
</ul>
</div>
<div id="what-to-plan-ahead-1" class="slide section level1">
<h1>What to plan ahead</h1>
<div class="figure">
<img src="img/data-flow-chart" alt="" />
<p class="caption">image</p>
</div>
</div>
<div id="setting-the-stage" class="slide section level1">
<h1>Setting the stage</h1>
<p><strong>Exercise</strong></p>
<ol style="list-style-type: decimal">
<li>Launch Stata by opening the Stata project in <code>DataWork/Introduction to Stata.stpr</code></li>
<li>Open a new do-file</li>
<li>Load the clean process data set into</li>
</ol>
</div>
<div id="setting-the-stage-1" class="slide section level1">
<h1>Setting the stage</h1>
<p><strong>Exercise</strong></p>
<pre><code>use &quot;Data/Clean/process_clean.dta&quot;, clear</code></pre>
</div>
<div id="create-new-numeric-variables" class="slide section level1">
<h1>Create new numeric variables</h1>
<p>Here are some simple mathematical operations that can be applied to numeric variables:</p>
<ul>
<li><strong>Addition:</strong> <code>numvar1 + numvar2</code> or <code>numvar + num</code></li>
<li><strong>Subtraction:</strong> <code>numvar1 - numvar2</code> or <code>numvar - num</code></li>
<li><strong>Multiplication:</strong> <code>numvar1 * numvar2</code> or <code>numvar * num</code></li>
<li><strong>Division:</strong> <code>numvar1 / numvar2</code> or <code>numvar / num</code></li>
</ul>
</div>
<div id="construct-numeric-variables" class="slide section level1">
<h1>Construct numeric variables</h1>
<p><strong>Exercise:</strong> use the <code>generate</code> command to create a new variable in the data set that changes the order of magnitude of contract values from 1 HKR to 100.000 HRK.</p>
</div>
<div id="construct-numeric-variables-1" class="slide section level1">
<h1>Construct numeric variables</h1>
<p><strong>Exercise:</strong> use the <code>generate</code> command to create a new variable in the data set that changes the order of magnitude of contract values from 1 HKR to 100.000 HRK.</p>
<pre><code>gen value_100k = Process_VrijednostNabaven/100000</code></pre>
</div>
<div id="construct-date-difference-variables" class="slide section level1">
<h1>Construct date difference variables</h1>
<p>The difference between two date-time variables can the calculated using the function <code>datediff()</code>:</p>
<pre><code>datediff(date1, date2, unit) </code></pre>
<p>where units can be:</p>
<ul>
<li>“day” or “d” for day</li>
<li>“hour” or “h” for hour</li>
<li>“minute”, “min”, or “m” for minute</li>
<li>“second”, “sec”, or “s” for second</li>
<li>“millisecond” or “ms” for millisecond</li>
<li>“month”, “mon”, or “m” for month</li>
<li>“year” or “y” for year</li>
</ul>
</div>
<div id="construct-date-difference-variables-1" class="slide section level1">
<h1>Construct date difference variables</h1>
<p><strong>Exercise:</strong> calculate the difference in days between the initiation of the process and the deadline for bid submission. Call it <code>bid_period</code></p>
</div>
<div id="construct-date-difference-variables-2" class="slide section level1">
<h1>Construct date difference variables</h1>
<p><strong>Exercise:</strong> calculate the number of days between the initiation of the process and the deadline for bid submission. Call it <code>bid_period</code></p>
<pre><code>gen bid_period = datediff(initiation_date, bid_submission_date, &quot;day&quot;)
summarize bid_period</code></pre>
</div>
<div id="extract-information-from-date-variables" class="slide section level1">
<h1>Extract information from date variables</h1>
<p>The following functions can be used to create derived variables can be created from dates in <code>%td</code> format</p>
<ul>
<li><code>year(d)</code>: numeric year corresponding to date <code>d</code></li>
<li><code>quarter(d)</code>: numeric quarter of the year corresponding to date <code>d</code></li>
<li><code>month(d)</code>: numeric month corresponding to date <code>d</code></li>
<li><code>week(d)</code>: numeric week of the year corresponding to date <code>d</code></li>
<li><code>day(d)</code>: numeric day of the month corresponding to <code>d</code></li>
</ul>
</div>
<div id="extract-information-from-date-variables-1" class="slide section level1">
<h1>Extract information from date variables</h1>
<pre><code>year_init = year(initiation_date)</code></pre>
<p><strong>Exercise:</strong> create two new variables, representin the month and quarter when the process was initiated</p>
</div>
<div id="extract-information-from-date-variables-2" class="slide section level1">
<h1>Extract information from date variables</h1>
<p><strong>Exercise:</strong> create two new variables, representin the month and quarter when the process was initiated</p>
<pre><code>month_init = month(initiation_date)
quarter_init = quarter(initiation_date)</code></pre>
</div>
<div id="extract-information-from-date-variables-3" class="slide section level1">
<h1>Extract information from date variables</h1>
<ul>
<li><code>mdy(M,D,Y)</code>: the date corresponding to month M, day D, year Y</li>
<li><code>yq(Y,Q)</code>: the quarterly date corresponding to year Y, quarter Q</li>
</ul>
<p>For example, <code>gen today = mdy(10,19,2021)</code> and <code>gen today = td(19oct2021)</code> would create the same values.</p>
<p><strong>Exercise:</strong> create a new variable called <code>yquarter_init</code> that indicates</p>
</div>
<div id="extract-information-from-date-variables-4" class="slide section level1">
<h1>Extract information from date variables</h1>
<p><strong>Exercise:</strong> create a new variable called <code>yquarter_init</code> that indicates</p>
<pre><code>gen      yquarter_init = yq(year_init, quarter_init) 
format      yquarter_init %tq
codebook yquarter_init</code></pre>
</div>
<div id="create-new-variables-egen" class="slide section level1">
<h1>Create new variables: <code>egen</code></h1>
<ul>
<li>Apart from the <code>generate</code> command, there is another command that is very useful when creating new variables</li>
<li>It is called <code>egen</code>, or “extended generate”</li>
<li>There is a number of functions that will only work when used with <code>egen</code></li>
<li>There are too many of them, and we will not discuss all, but you can see a complete list by typing <code>help egen</code></li>
</ul>
</div>
<div id="create-new-variables-egen-1" class="slide section level1">
<h1>Create new variables: <code>egen</code></h1>
<ul>
<li>This command is particularly useful when we want to aggregate information across rows without changing the level of observation in the data set</li>
<li>Say, for example, that we want to calculate the weight of one process on the total contracted value by an entity</li>
<li>We would need to divide the process value by the total value contracted by the entity</li>
<li><code>egen</code> allows us to calcualte the total contracting value without changing the unit of observation of the data set as follows</li>
</ul>
<pre><code>egen total_value = sum(process_value), by(entity)</code></pre>
</div>
<div id="create-new-variables-egen-2" class="slide section level1">
<h1>Create new variables: <code>egen</code></h1>
<p><strong>Exercise:</strong> create a new variable called <code>nr_process</code> that counts the total number of processes started by a procuring entity.</p>
<ul>
<li><em>Tip:</em> look at <code>egen</code>’s help file to find a function that counts the number of non-missing observations for a variable.</li>
</ul>
</div>
<div id="create-new-variables-egen-3" class="slide section level1">
<h1>Create new variables: <code>egen</code></h1>
<p><strong>Exercise:</strong> create a new variable called <code>nr_process</code> that counts the total number of processes started by a procuring entity.</p>
<pre><code>egen nr_process = count(process_value), by(entity)</code></pre>
</div>
<div id="create-new-variables-best-practices" class="slide section level1">
<h1>Create new variables: best practices</h1>
<ul>
<li>Create new variables instead of overwriting the original information</li>
<li>Order the data set so that related variables are close to each other</li>
</ul>
</div>
<div id="creating-aggregate-measures-best-practices" class="slide section level1">
<h1>Creating aggregate measures: best practices</h1>
<ul>
<li>Check and double-check the value assignments of questions, as well as their scales, before constructing new variables based on them</li>
<li>Look at the distributions of both the original and the constructed variables</li>
<li>Be mindful of how missing values are treated</li>
</ul>
</div>
<div id="aggregating-observations-collapse" class="slide section level1">
<h1>Aggregating observations: <code>collapse</code></h1>
<ul>
<li>We have seens how <code>egen</code> allows us to aggregate observations by group without changing the unit of observation of the data set</li>
<li>Sometimes, however, we do want to change the unit of observation</li>
<li>In these cases, we will use the command <code>collapse</code></li>
<li>It works as follows:</li>
</ul>
<pre><code>collapse (sum) total_value = process_value (count) nr_bids = bid_id, by(entity)</code></pre>
</div>
<div id="aggregating-observations-collapse-1" class="slide section level1">
<h1>Aggregating observations: <code>collapse</code></h1>
<p>Note that running this command will completely change the data set in memory</p>
<pre><code>codebook</code></pre>
</div>
<div id="aggregating-observations-collapse-2" class="slide section level1">
<h1>Aggregating observations: <code>collapse</code></h1>
<p>There is a number of different statistics that can be used with <code>collapse</code>, including:</p>
<ul>
<li><code>mean</code></li>
<li><code>median</code></li>
<li><code>sd</code></li>
<li><code>sum</code></li>
<li><code>count</code></li>
<li><code>percent</code></li>
<li><code>min</code></li>
<li><code>max</code></li>
</ul>
</div>
<div id="combining-data-sets" class="slide section level1">
<h1>Combining data sets</h1>
<ul>
<li>All the construction operations we have seen so far are using a single data set</li>
<li>However, we often have separate tidy data sets that we need to combine to create our final indicators</li>
<li>There are two main ways of combining data sets:
<ul>
<li><em>Appending</em>, when we combine data sets that have more or less the same columns, but different instances of the unit of observation to increase the number of observations</li>
<li><em>Merging</em>, when we combine data sets that comtain more or less the same instances of the unit of observation, but different variables, to create a data set with more columns than the original ones</li>
</ul></li>
</ul>
<p>Can you think of cases when you would need to perform <em>merges</em> or <em>appends</em>?</p>
</div>
<div id="combining-data-sets-1" class="slide section level1">
<h1>Combining data sets</h1>
<ul>
<li>Examples of <em>appending</em> include:
<ul>
<li>Combining data from different years</li>
<li>Combining data from different countries</li>
</ul></li>
<li>Examples of <em>merging</em> include:
<ul>
<li>Combining data on contracts and bids for a given process</li>
<li>Including product information on contract data set</li>
<li>Adding entity information on a process data set</li>
</ul></li>
</ul>
</div>
<div id="combining-data-sets-append" class="slide section level1">
<h1>Combining data sets: <code>append</code></h1>
<pre><code>append using filename [filename ...] [, options]</code></pre>
<ul>
<li>Note that now we have more than one data set, which has not happened so far</li>
<li>Stata can only have one data set in memory at once, so we need to call data sets saved as .dta (or as temporary files, but that is a more advanced topic)</li>
<li><code>append</code> will add the observations in the <em>using</em> data set (the one referred to by its file name) to the <em>master</em> data set (the one that is currently loaded in the memory)</li>
</ul>
<pre><code>append using &quot;Data/Intermediate/entities_2018.dta&quot; &quot;Data/Intermediate/entities_2019.dta&quot;</code></pre>
</div>
<div id="combining-data-sets-append-1" class="slide section level1">
<h1>Combining data sets: <code>append</code></h1>
<ul>
<li>When a variable is present in only one of the datasets, its values will be missing for all observations that came from the data set that did not include it</li>
<li>If columns with the same name have different types of variables in the two data sets (for example, one is a string and one is numeric), this will cause the append to fail</li>
<li>You can use the option <code>gen(newvar)</code> to include a new variable indicating from which data set each observation came</li>
<li>Note that it only makes sense to append data sets that have the same <em>unit of observation</em></li>
</ul>
</div>
<div id="combining-data-sets-append-2" class="slide section level1">
<h1>Combining data sets: <code>append</code></h1>
<p><strong>Exercise:</strong> explore the different options of the command <code>append</code> using the different years found in the <code>Data/Intermediate</code> folder</p>
</div>
<div id="combining-data-sets-merge" class="slide section level1">
<h1>Combining data sets: <code>merge</code></h1>
<p>One-to-one merge on specified key variables</p>
<pre><code>merge 1:1 varlist using filename [, options]</code></pre>
<p>Many-to-one merge on specified key variables</p>
<pre><code>merge m:1 varlist using filename [, options]</code></pre>
</div>
<div id="combining-data-sets-merge-1" class="slide section level1">
<h1>Combining data sets: <code>merge</code></h1>
<ul>
<li>It only makes sense to merge two data sets that have <strong>common observations</strong></li>
<li>The syntax of the command makes it clear that when merging two data sets, they need to have at least one variable in common</li>
<li>This is one the points in the data work where having uniquely identifying variables is extremely important!</li>
<li>When merging two data sets, we first need to load one of them in memory (this will be called the <em>master</em> data), and then refer to the other one (the <em>using</em> data set) by its filename</li>
</ul>
<pre><code>use &quot;Data/Clean/process_clean.dta&quot;, clear

merge 1:m Nadmetanje_ID usign &quot;Data/Clean/contract_clean.dta&quot;</code></pre>
</div>
<div id="combining-data-sets-merge-2" class="slide section level1">
<h1>Combining data sets: <code>merge</code></h1>
<pre><code>use &quot;Data/Clean/process_clean.dta&quot;, clear

merge 1:m Nadmetanje_ID usign &quot;Data/Clean/contract_clean.dta&quot;</code></pre>
<ul>
<li>Note that Stata lets you know how well the match between the two data sets went</li>
<li>There are also a series of options that allow you to test the the result of the merge matches your expections</li>
</ul>
</div>
<div id="combining-data-sets-merge-3" class="slide section level1">
<h1>Combining data sets: <code>merge</code></h1>
<p><img src="img/merge-opts.png" /></p>
</div>
<div id="where-things-go-wrong" class="slide section level1">
<h1>Where things go wrong</h1>
<ul>
<li>The more complex construction tasks involve changing the structure of the data, such as sample and unit of observation</li>
<li>Merges and collapses may change the number of observation and create missing entries</li>
<li>Make sure to read about how each command treats missing observations</li>
</ul>
</div>
<div id="write-pseudocode" class="slide section level1">
<h1>Write pseudocode</h1>
<ul>
<li>Describe the steps to create your indicator in plain English</li>
<li>Refine the sub-steps involved</li>
<li>When you are getting into too much detail, write code</li>
<li>Think about possible errors that may come up at each sub-step</li>
</ul>
</div>
<div id="think-about-expected-results" class="slide section level1">
<h1>Think about expected results</h1>
<ul>
<li>Think about how the command you are using treats missing values</li>
<li>Try to predict the result you will get
<ul>
<li>Will all observations merge?</li>
<li>Will the number of observations change?</li>
<li>Will missing values be created?</li>
</ul></li>
</ul>
</div>
<div id="document-the-observed-results" class="slide section level1">
<h1>Document the observed results</h1>
<ul>
<li>Explore the actual results from the operation</li>
<li>Write down in comments what happened</li>
<li>Add comments to the code explaining unexpected consequences</li>
</ul>
</div>
<div id="construction-indicators-in-panel-data-sets" class="slide section level1">
<h1>Construction indicators in panel data sets</h1>
<ul>
<li>It is common to construct indicators soon after receiving data from a new survey round</li>
<li>However, creating indicators for each round separately increases the risk of using different definitions every time</li>
<li>Having a well-established definition for each constructed variable helps prevent that mistake</li>
<li>But the best way to guarantee it won’t happen is to merge all rounds of data collection first and create the indicators for all rounds in the same script</li>
<li>In addition to preventing inconsistencies, this process will also save you time and give you an opportunity to review your original construction code</li>
</ul>
</div>
<div id="constructed-data-sets" class="slide section level1">
<h1>Constructed data sets</h1>
<ul>
<li>A constructed data set is built to answer an analysis question</li>
<li>Different pieces of analysis may have different units of analysis</li>
<li>You may have as many constructed data sets as required for analysis</li>
<li>Don’t worry if you cannot create a single, “canonical” analysis data set</li>
<li>If you have multiple constructed data sets, name them carefully so you know when to use each of them</li>
</ul>
</div>
<div id="documenting-construction" class="slide section level1">
<h1>Documenting construction</h1>
<ul>
<li>Documentation is an output of construction as relevant as the code and the data</li>
<li>Someone unfamiliar with the project should be able to understand the contents of the analysis data sets, and the steps taken to create them</li>
<li>Document exactly how each variable is derived or calculated</li>
<li>Carefully record how specific variables have been combined, recoded, and scaled, and refer to those records in the code</li>
<li>This can be part of a wider discussion with your team about creating protocols for variable definition, which will guarantee that indicators are defined consistently across projects</li>
</ul>
</div>
<div id="construction-documentation-should-include" class="slide section level1">
<h1>Construction documentation should include</h1>
<ul>
<li>A data dictionary with the definition of all variables in the each analysis data table</li>
<li>A codebook with summary statistics and other description of all variables in each analysis data table</li>
<li>References to the sources of variable definitions</li>
<li>Comments on the code explaining each step of the construction and referring to the data dictionary and sources of variable definitions</li>
</ul>
</div>
<div id="recap" class="slide section level1">
<h1>Recap</h1>
<ul>
<li>During construction, you will create purpose-built datasets to answer your <strong>research questions</strong></li>
<li>You should maintain <strong>separate cleaning, construction and analysis scripts</strong>, even if they are simultaneously edited and executed by the master script</li>
<li>Create <strong>purpose-built analysis datasets</strong>, naming and saving them appropriately, and using them for the corresponding analytical tasks, rather than building a single dataset</li>
<li><strong>Carefully document</strong> each of these steps in plain and clear language, so that the rationale behind each research decision is clear for any research consumer</li>
</ul>
</div>
<div id="why-is-construction-a-separate-task-from-data-analysis" class="slide section level1">
<h1>Why is construction a separate task from data analysis?</h1>
<ul>
<li>In practice, data construction often times happens at the same time as data analysis</li>
<li>As you analyze the data, different constructed variables will become necessary, as well as subsets and other alterations to the data</li>
<li>However, even if construction ends up coming before analysis only in the order the code is run, it’s important to think of them as different steps</li>
</ul>
</div>
<div id="why-is-construction-a-separate-task-from-data-analysis-1" class="slide section level1">
<h1>Why is construction a separate task from data analysis?</h1>
<ul>
<li>Maintainability: If every analysis script cleans and constructs variables from the raw data, any edits to this process need to be replicated in all scripts that use the same final variable.</li>
<li>Preventing errors: The difficulty to maintain such scripts increases the chances that at least one of them will have a different sample or variable definition.</li>
</ul>
<p>Doing all variable construction and data transformation in a unified script, separate from the analysis code, helps avoid this and ensures consistency across different outputs.</p>
</div>
<div id="appendix" class="slide section level1">
<h1>Appendix</h1>
</div>
<div id="advanced-mathematical-operations" class="slide section level1">
<h1>Advanced mathematical operations</h1>
<pre><code>**Logarithm:** `ln(numvar)`
**Square root:** `sqrt(numvar)`
**Exponentiation:** `numvar^num`</code></pre>
</div>
<div id="create-new-date-variable" class="slide section level1">
<h1>Create new date variable</h1>
<pre><code>gen date2 = mdy(m2, d2, 2002)</code></pre>
</div>
<div id="aggregating-varaibles" class="slide section level1">
<h1>Aggregating varaibles</h1>
<ul>
<li><code>gen income_total = income_wage + income_rent + income_sales</code></li>
<li><code>egen income_total = rowtotal(income_wage income_rent income_sales)</code></li>
<li><code>egen income_total = rowtotal(income_wage income_rent income_sales), m</code></li>
</ul>
</div>
<div id="merge-best-practices" class="slide section level1">
<h1>Merge best practices</h1>
</div>
</div>
</body>
</html>
